<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Orbit Boss — Alien Face Edition (Fixed)</title>
<style>
  html,body{margin:0;height:100%;background:#05060a;overflow:hidden;color:#bfe9ff;font-family:sans-serif}
  canvas{display:block;width:100vw;height:100vh}
  #hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);display:flex;gap:.6rem;pointer-events:none}
  .pill{background:#0c111f;border:1px solid #2a3a60;border-radius:999px;padding:.25rem .6rem}
  .pill strong{color:#8fd2ff}
  #centerMsg{position:fixed;inset:0;display:grid;place-items:center;text-align:center;transition:opacity .35s ease}
  #centerMsg.hidden{opacity:0;pointer-events:none}
  #centerMsg .card{background:rgba(5,8,20,.85);border:1px solid #24305a;border-radius:12px;padding:18px 22px}
  kbd{background:#111835;border:1px solid #31407a;border-bottom-width:2px;border-radius:6px;padding:.1rem .3rem;color:#cfe5ff}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud"></div>
<div id="centerMsg"><div class="card" id="msg">
  Orbit Boss<br><small><kbd>W</kbd>/<kbd>S</kbd> = in/out · <kbd>A</kbd> = flip · <kbd>D</kbd> = shoot · auto move</small>
</div></div>

<script>
(() => {
// ===== Base setup =====
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const hud=document.getElementById("hud");
const msg=document.getElementById("msg");
const centerMsg=document.getElementById("centerMsg");

const state={w:innerWidth,h:innerHeight,level:1,score:0,time:0,running:true,moved:false};
const resize=()=>{canvas.width=innerWidth;canvas.height=innerHeight;state.w=innerWidth;state.h=innerHeight};
addEventListener("resize",resize,{passive:true});resize();

const TAU=Math.PI*2, clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const randRange=(a,b)=>a+Math.random()*(b-a);
const nowMs=()=>performance.now();

// ===== Entities =====
const player={
  angle:0, radius:180, minR:110, maxR:260,
  speed:2.2, alive:true, invincible:0, dir:1,
  lastShotMs:0, shootCooldown:2000 // ms; 2.0s at L1, -0.1s/level
};

const boss={
  hp:20, maxHp:20, coreR:32,
  fireTimer:0, fireCooldown:1.2, fireHold:0,
  eyes:[], mouth:{open:0},
  tentacles:[]
};

const bullets=[];    // player + boss bullets
const asteroids=[];  // only Level >= 3
const keys={};

// ===== Input =====
onkeydown=e=>{
  const k=e.key.toLowerCase();
  if(['w','a','s','d','r'].includes(k)) e.preventDefault();
  keys[k]=true;
  if(!state.moved && ['w','a','s','d'].includes(k)) hideCenter();
  if(k==='a') player.dir*=-1;
  if(k==='d') tryShoot();     // single shot, cooldown-gated
  if(k==='r') reset();
};
onkeyup=e=>{ delete keys[e.key.toLowerCase()]; };

function hideCenter(){ centerMsg.classList.add('hidden'); state.moved=true; }
function flash(txt){ msg.innerHTML=txt; centerMsg.classList.remove('hidden'); setTimeout(()=>centerMsg.classList.add('hidden'), 2200); }
function showGameOver(){
  centerMsg.classList.remove('hidden');
  msg.innerHTML=`<div style="font-size:1.1rem;margin-bottom:.3rem;">Game Over</div>
  <div>Score: <strong>${state.score}</strong> — Level: <strong>${state.level}</strong></div><div>Press <kbd>R</kbd> to restart</div>`;
}

// ===== Level init / reset =====
function initAlienFace(){
  boss.eyes = [
    {off:{x:-boss.coreR*0.8, y:-boss.coreR*0.25}},
    {off:{x:+boss.coreR*0.8, y:-boss.coreR*0.15}}
  ];
  boss.mouth = {open:0};

  boss.tentacles = [];
  const tentCount = 8;
  for(let i=0;i<tentCount;i++){
    boss.tentacles.push({
      baseAng: Math.random()*TAU,
      baseLen: randRange(70,120),
      amp: randRange(0.12,0.28),
      speed: randRange(1.0,1.8),
      segs: 8 + Math.floor(Math.random()*4),
      phase: Math.random()*TAU
    });
  }
}

function initAsteroids(){
  asteroids.length = 0;
  if(state.level < 3) return;
  const count = Math.min(3 + (state.level-3)*2, 14);
  for(let i=0;i<count;i++){
    const x = randRange(40, state.w-40);
    const y = randRange(40, state.h-40);
    const spd = randRange(60, 140) * (1 + (state.level-3)*0.06);
    const ang = Math.random()*TAU;
    asteroids.push({
      x, y,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd,
      size: randRange(12,20),
      rot: Math.random()*TAU,
      rotSpeed: randRange(-1,1)
    });
  }
}

function initLevel(){
  const lvl=state.level;
  boss.maxHp = Math.floor(22 + (lvl-1)*10);
  boss.hp = boss.maxHp;
  boss.fireCooldown = Math.max(0.8, 1.5 - (lvl-1)*0.08);
  boss.fireHold = 1.0; // short intro delay each level

  // cooldown (ms): 2.0 - 0.1*level-1, min 0.3
  const cdSec = clamp(2.0 - (lvl-1)*0.1, 0.3, 2.0);
  player.shootCooldown = cdSec * 1000;

  initAlienFace();
  initAsteroids();
  bullets.length = 0;
}

function reset(){
  state.level=1; state.score=0; state.time=0; state.running=true;
  player.angle=0; player.radius=180; player.alive=true; player.invincible=0; player.dir=1;
  player.lastShotMs=0;
  asteroids.length=0; bullets.length=0; state.moved=false; centerMsg.classList.remove('hidden');
  initLevel();
}

function nextLevel(){
  state.level++;
  state.score += 200;
  player.invincible = 1.2;
  initLevel();
  flash(`Level ${state.level}<br><small>It mutates… and space gets crowded.</small>`);
}

// ===== Shooting (single shot per press, cooldown) =====
function canShoot(){ return (nowMs() - player.lastShotMs) >= player.shootCooldown; }

function tryShoot(){
  if(!player.alive) return;
  if(!canShoot()) return;
  player.lastShotMs = nowMs();
  spawnPlayerBullet();
}

function spawnPlayerBullet(){
  const cx=state.w/2, cy=state.h/2;
  const px=cx + Math.cos(player.angle)*player.radius;
  const py=cy + Math.sin(player.angle)*player.radius;
  const ang=Math.atan2(cy-py, cx-px);
  const spd=580;
  bullets.push({
    x:px, y:py,
    vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd,
    r:3, owner:'p',
    flameHue: 20+Math.random()*30, // for fire tint
    born: state.time
  });
}

// ===== Boss volley (one aimed + random spread) =====
function bossVolley(){
  const lvl=state.level;
  const cx=state.w/2, cy=state.h/2;
  const px=cx + Math.cos(player.angle)*player.radius;
  const py=cy + Math.sin(player.angle)*player.radius;
  const aimAng = Math.atan2(py-cy, px-cx);
  const count = Math.min(10, 2 + lvl*2);

  for(let i=0;i<count;i++){
    const ang = (i===0) ? (aimAng + randRange(-0.08, 0.08)) : Math.random()*TAU;
    const spd = 150 + lvl*25;
    bullets.push({ x:cx, y:cy, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd, r:3.2, owner:'b' });
  }
}

// ===== Update =====
function update(dt){
  state.time += dt;
  if(!player.alive) return;

  if(player.invincible>0) player.invincible=Math.max(0, player.invincible - dt);
  if(boss.fireHold>0) boss.fireHold=Math.max(0, boss.fireHold - dt);

  // Auto rotation + radius control
  player.angle += player.dir * player.speed * dt;
  if(keys['w']) player.radius -= 130*dt;
  if(keys['s']) player.radius += 130*dt;
  player.radius = clamp(player.radius, player.minR, player.maxR);

  // Boss timing
  boss.fireTimer += dt;
  if(boss.fireHold===0 && boss.fireTimer >= boss.fireCooldown){
    boss.fireTimer = 0;
    boss.mouth.open = 1.0; // quick tell
    bossVolley();
  }
  boss.mouth.open = Math.max(0, boss.mouth.open - dt*1.5);

  // Asteroids move + bounce (only if level >= 3)
  for(const a of asteroids){
    a.x += a.vx*dt; a.y += a.vy*dt;
    a.rot += a.rotSpeed*dt;
    if(a.x < a.size){ a.x=a.size; a.vx*=-1; }
    if(a.x > state.w - a.size){ a.x=state.w - a.size; a.vx*=-1; }
    if(a.y < a.size){ a.y=a.size; a.vy*=-1; }
    if(a.y > state.h - a.size){ a.y=state.h - a.size; a.vy*=-1; }
  }

  // Bullets update + collisions
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.x += b.vx*dt; b.y += b.vy*dt;
    if(b.x<-100||b.y<-100||b.x>state.w+100||b.y>state.h+100){ bullets.splice(i,1); continue; }

    const cx=state.w/2, cy=state.h/2;
    const dx=b.x-cx, dy=b.y-cy, dist=Math.hypot(dx,dy);

    if(b.owner==='p'){
      if(dist <= boss.coreR){
        bullets.splice(i,1);
        boss.hp--; state.score += 5;
        if(boss.hp<=0) nextLevel();
      }
    } else {
      const px=cx + Math.cos(player.angle)*player.radius;
      const py=cy + Math.sin(player.angle)*player.radius;
      if(Math.hypot(b.x-px, b.y-py) < 10){
        if(player.invincible>0){ bullets.splice(i,1); continue; }
        bullets.splice(i,1);
        player.alive=false; state.running=false; showGameOver();
      }
    }
  }

  // Asteroid collision with player
  const cx=state.w/2, cy=state.h/2;
  const px=cx + Math.cos(player.angle)*player.radius;
  const py=cy + Math.sin(player.angle)*player.radius;
  for(const a of asteroids){
    if (Math.hypot(a.x - px, a.y - py) < a.size + 9){
      if(player.invincible<=0){
        player.alive=false; state.running=false; showGameOver();
      }
    }
  }
}

// ===== Draw =====
function drawShip(x,y,ang){
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(ang);

// outline + fill when ready
const ready = canShoot();
ctx.beginPath();
ctx.moveTo(14,0);
ctx.lineTo(-10,-7);
ctx.lineTo(-4,0);
ctx.lineTo(-10,7);
ctx.closePath();

if (ready) {
  ctx.fillStyle = '#ff4444'; // red fill when ready
  ctx.fill();
} else {
  ctx.fillStyle = '#162036'; // dark fill otherwise
  ctx.fill();
}

ctx.strokeStyle = '#aee3ff';
ctx.lineWidth = 2;
ctx.stroke();

  // Slithering tentacles
  ctx.lineWidth=1.8;
  ctx.strokeStyle='#ffcc55';
  for(const tent of boss.tentacles){
    const segs = tent.segs;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    for(let i=1;i<=segs;i++){
      const p=i/segs;
      const wave = Math.sin(t*tent.speed + tent.phase + p*3)*tent.amp;
      const dir = tent.baseAng + wave;
      const r = tent.baseLen * p;
      const x = cx + Math.cos(dir)*r;
      const y = cy + Math.sin(dir)*r;
      ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  // Face polygon (irregular)
  ctx.strokeStyle = boss.hp < boss.maxHp/2 ? (t*6%2>1 ? '#ff5577' : '#ff8899') : '#85d8ff';
  ctx.lineWidth=3;
  const sides=6;
  ctx.beginPath();
  for(let i=0;i<sides;i++){
    const a = t*0.25 + i*TAU/sides + Math.sin(t*1.3 + i)*0.12;
    const r = boss.coreR * (0.85 + 0.25*Math.sin(t*0.9 + i));
    const x = cx + Math.cos(a)*r;
    const y = cy + Math.sin(a)*r;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.closePath(); ctx.stroke();

  // Eyes
  for(const e of boss.eyes){
    const ex = cx + e.off.x + Math.sin(t*1.1)*2;
    const ey = cy + e.off.y + Math.cos(t*0.9)*2;
    ctx.fillStyle = '#ffffff';
    ctx.beginPath(); ctx.arc(ex,ey,4,0,TAU); ctx.fill();
    // pupil (red when about to fire)
    const aboutToFire = boss.fireHold===0 && boss.fireTimer>boss.fireCooldown*0.8;
    ctx.fillStyle = aboutToFire ? '#ff3333' : '#222a4a';
    ctx.beginPath(); ctx.arc(ex + Math.sin(t*4)*0.8, ey, 1.7, 0, TAU); ctx.fill();
  }

  // Mouth (jagged)
  const open = 0.2 + boss.mouth.open*0.5 + 0.15*Math.sin(t*2.2);
  const mw = boss.coreR*1.1, mh = boss.coreR*0.5*open;
  ctx.strokeStyle='#ffcc55'; ctx.lineWidth=2;
  ctx.beginPath();
  const teeth=7;
  for(let i=0;i<=teeth;i++){
    const p=i/teeth;
    const x = cx - mw/2 + p*mw;
    const y = cy + boss.coreR*0.2 + (i%2? -mh : mh);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function drawAsteroids(){
  if(state.level < 3) return;
  ctx.strokeStyle='#8d99b3';
  ctx.lineWidth=2;
  for(const a of asteroids){
    ctx.save();
    ctx.translate(a.x, a.y);
    ctx.rotate(a.rot);
    const s=a.size;
    ctx.beginPath();
    ctx.rect(-s, -s, s*2, s*2);
    ctx.stroke();
    ctx.restore();
  }
}

function drawBullets(){
  for(const b of bullets){
    if(b.owner==='p'){
      // fireball look (flicker size + hue)
      const age = state.time - (b.born||0);
      const flick = Math.sin(age*30 + b.flameHue)*0.2;
      const size = b.r * (1 + flick);
      const hue = b.flameHue + Math.sin(age*40 + b.flameHue)*12;
      ctx.fillStyle = `hsl(${hue},100%,60%)`;
      ctx.beginPath(); ctx.arc(b.x,b.y,size,0,TAU); ctx.fill();
    } else {
      ctx.fillStyle='#ff904f';
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,TAU); ctx.fill();
    }
  }
}

function draw(){
  const w=state.w, h=state.h;
  ctx.clearRect(0,0,w,h);

  // faint concentric rings
  const cx=w/2, cy=h/2;
  ctx.save(); ctx.strokeStyle='#242a3c'; ctx.globalAlpha=0.2;
  for(let r=80;r<Math.max(w,h);r+=80){ ctx.beginPath(); ctx.arc(cx,cy,r,0,TAU); ctx.stroke(); }
  ctx.restore();

  drawAlienFace(cx,cy);
  drawAsteroids();

  // player
  const px=cx + Math.cos(player.angle)*player.radius;
  const py=cy + Math.sin(player.angle)*player.radius;
  drawShip(px,py,player.angle+Math.PI);

  drawBullets();

  // HUD (no cooldown pill anymore)
  hud.innerHTML = `
    <div class='pill'><strong>Lvl</strong> ${state.level}</div>
    <div class='pill'><strong>Boss</strong> ${Math.max(0,boss.hp)}/${boss.maxHp}</div>
    <div class='pill'><strong>Score</strong> ${state.score}</div>
  `;
}

// ===== Loop =====
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033,(now-last)/1000);
  last=now;
  if(state.running) update(dt);
  draw();
  requestAnimationFrame(loop);
}
function start(){ initLevel(); requestAnimationFrame(loop); }
start();
})();
</script>
</body>
</html>
